# axis_ddr_mgr_fd

Параметризуемый компонент для реализации возможности записи/чтения потока с памятью по шине AXI-Stream. Предполагается, что сама память работает на основе AXI-FULL

Компонент поддерживает параметризацию разрядности адреса, данных и размера burst-транзакций

![axis_ddr_mgr_fd_struct][axis_ddr_mgr_fd_struct_reg]

[axis_ddr_mgr_fd_struct_reg]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_ddr_mgr_fd/documentation/axis_ddr_mgr_fd_struct.png

## generic-параметры
Параметр | Тип | Диапазон значений | описание
---------|-----|-------------------|---------
ADDR_WIDTH | integer | >0 | Размер шины адреса AXI-Full
DATA_WIDTH | integer | >0 | Размер шины данных AXI-Stream/AXI-Full
BURST_LIMIT | integer | >0 | Размер BURST-транзакций

## Порты 

### сигналы тактирования и сброса 

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
CLK | input | 1 | сигнал тактирования
RESET | input | 1 | сигнал сброса. Синхонный по отношению к CLK

Примечание: Компонент не поддерживает асинхронного режима для шин AXI-Full, AXI-Streamю. Все сигналы тактируются от CLK

### Сигналы управления

Компонент поддерживает только полудуплексный режим работы. Транзакции одновременного чтения и записи невозможны. 

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
CMD_START_ADDRESS | input | ADDR_WIDTH | Начальный адрес памяти откуда выполнять чтение
CMD_SIZE | input | 64 | Размер читаемых данных в байтах
CMD_MODE | input | 2 | Операция
CMD_VALID | input | 1 | Валидность команды 

### AXI-Stream 

Компонент работает на основе протокола AXI-Stream. 
Компонент выступает в качестве Slave AXI-Stream для операций записи. 
Компонент выступает в качестве Master AXI-Stream Для операций чтений.

Компонент не поддерживает TKEEP

Все сигналы тактируются от CLK. Сигналом сброса служит RESET.

#### AXI-Stream Slave

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
S_AXIS_TDATA | input | DATA_WIDTH | сигнал данных на запись
S_AXIS_TVALID | input | 1 | сигнал валидности
S_AXIS_TREADY | output | 1 | сигнал готовности устройства к приему данных
S_AXIS_TLAST | input | 1 | сигнал конца пакета.

#### AXI-Stream Master

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
M_AXIS_TDATA | output | DATA_WIDTH | сигнал данных на чтение
M_AXIS_TVALID | output | 1 | сигнал валидности
M_AXIS_TREADY | input | 1 | сигнал готовности устройства к приему данных
M_AXIS_TLAST | output | 1 | сигнал конца пакета.

### AXI-Full
Компонент поддерживает интерфейс AXI-Full. 
Единственным ограничением является невозможность выполнять одновременно операции чтения и записи в один момент времени. 
Это связано с тем, что транзакции задаются через одну конфигурационную шину, в которой выбирается сама операция, которую надо выполнить. 

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
M_AXI_AWADDR  | output | ADDR_WIDTH | Шина адреса канала записи
M_AXI_AWLEN   | output | 8 | Длина Burst
M_AXI_AWSIZE  | output | 3 | Количество байт в каждом слове. Устанавливается в константу в соответствии с размером шины данных
M_AXI_AWBURST | output | 2 | Тип BURST. Устанавливается в константу(0x01h, тип burst: INCR)
M_AXI_AWLOCK  | output | 1 | Сигнал не используется, установлен в 0
M_AXI_AWCACHE | output | 4 | Сигнал не используется, установлен в 0
M_AXI_AWPROT  | output | 3 | Сигнал не используется, установлен в 0
M_AXI_AWVALID | output | 1 | Сигнал валидности адреса записи
M_AXI_AWREADY | input  | 1 | Сигнал готовности слейва к чтению адреса
M_AXI_WDATA   | output | DATA_WIDTH | Размер шины данных
M_AXI_WSTRB   | output | DATA_WIDTH/8 | валидность бит на шине. Установлен в 1.
M_AXI_WLAST   | output | 1 | Сигнал конца транзакции BURST
M_AXI_WVALID  | output | 1 | сигнал валидности данных
M_AXI_WREADY  | input  | 1 | Сигнал готовности к приему данных
M_AXI_BRESP   | input  | 2 | Сигнал отклика(статус) операции записи
M_AXI_BVALID  | input  | 1 | сигнал валидности статуса на шине
M_AXI_BREADY  | output | 1 | Сигнал готовности мастера читать статусный сигнал
M_AXI_ARADDR  | output | ADDR_WIDTH | Шина адреса канала чтения
M_AXI_ARLEN   | output | 8 | Длина BURST-транзакции
M_AXI_ARSIZE  | output | 3 | КОличество байт в слове. Устанавливается в константу в соответствии с размером шины данных
M_AXI_ARBURST | output | 2 | Тип BURST. Установлен в константу (0x01h, тип burst: INCR)
M_AXI_ARLOCK  | output | 1 | Сигнал не используется, установлен в 0
M_AXI_ARCACHE | output | 4 | Сигнал не используется, установлен в 0
M_AXI_ARPROT  | output | 3 | Сигнал не используется, установлен в 0
M_AXI_ARVALID | output | 1 | Сигнал валидности адреса 
M_AXI_ARREADY | input  | 1 | Сигнал готовности слейва к чтению адреса чтения
M_AXI_RDATA   | input  | DATA_WIDTH | Сигнал данных чтения от слейва к мастеру
M_AXI_RRESP   | input  | 2 | Сигнал отклика канала чтения
M_AXI_RLAST   | input  | 1 | Сигнал конца пакета
M_AXI_RVALID  | input  | 1 | Сигнал валидности данных слейва
M_AXI_RREADY  | output | 1 | Сигнал готовности к приему мастера


## некоторые принципы работы компонента. 

- Работа компонента строится на двух конечных автоматах: один конечный автомат для операции записи, второй конечный автомат - для операции чтения. 
- При этом, конечный автомат операции чтения зависит от работы конечного автомата операции записи. 
- Поддерживается только кратность слову(количество бит на шине). Таким образом при 4 байтной шине невозможно будет считать 1 байт. 
- Поддерживается режим добивания на кратность слову. Нет необходимости делать это вручную
- Поддержка burst-транзакций AXI4, до 256 слов за команду. 
- Поддержка TREADY-сигналов. Таким образом, потерять данные не получится. 
- Компонент не умеет анализировать границу адресного пространства. Таким образом, при попытке считать/записать данные с адреса, который выходит за границы адресного пространства, то результат удет непредсказуемым и не гарантируется корректная работа. 
- Содержит два компонента для развязки по AXI-Stream. 
- Контроль поддерживаемого BURST возлагается на разработчика.
- Поддерживается следующие режимы работы:


MODE | Название | Описание
-----|----------|---------
0x00 | Нет операции | Зарезервировано, не используется. 
0x01 | Чтение | Чтение N байт из памяти и передача их через `M_AXIS_`
0x10 | Запись | Запись N байт с шины `S_AXIS_` в память
0x11 | Запись с последующим чтением | Выполняется сначала запись, а потом чтение записанных данных из памяти

## Конечный автомат

Работа строится на двух конечных автоматах, каждый из которых выполняет операцию чтения или операцию записи. 

### Конечный автомат для операции чтения

#### Граф-схема автомата 

![read_fsm_diag][read_fsm_diagram]

[read_fsm_diagram]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_ddr_mgr_fd/documentation/read_fsm_diag.png

#### Состояния конечного автомата 

Текущее состояние | Следующее состояние | Условие перехода | Пояснение
------------------|---------------------|------------------|----------
IDLE_ST | WAIT_FOR_WRITE_ST | CMD_VALID = 1 & CMD_MODE = 11 | Если приходит запрос на команду записи то переход в ожидание окончания
IDLE_ST | READ_ST | CMD_VALID = 1 & CMD_MODE = 01 | Если приходит запрос на чтение то переход в режим чтения
WAIT_FOR_WRITE_ST | READ_ST | current_state_write = IDLE_ST | Если конечный автомат на запись закончил работу, то переход в состояние чтения
READ_ST | IDLE_ST | RVALID = 1 & RREADY = 1 RLAST = 1 and word_counter_read = 0 | При обнуления счетчика байт для текущей команды заканчиваем работу
READ_ST | WAIT_FOR_FIFO_ABILITY_RCV_ST | RVALID = 1 & RREADY = 1 & RLAST = 1 & out_pfull = 1 | При отсутствии места в выходной очереди(для M_AXIS_ шины) переходим в состояние ожидания опустошения очереди
WAIT_FOR_FIFO_ABILITY_ST | READ_ST | out_pfull = 0 | при освобождении места переходим в состояние чтения


### Конечный автомат для операции записи

#### Граф-схема автомата 

![write_fsm_diag][write_fsm_diagram]

[write_fsm_diagram]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_ddr_mgr_fd/documentation/write_fsm_diag.png

#### Состояния конечного автомата 

Текущее состояние | Следующее состояние | Условие перехода | Пояснение 
------------------|---------------------|------------------|----------
IDLE_ST | WAIT_FOR_DATA_ST | CMD_VALID = 1 & CMD_MODE(1) = 1 | Если приходит запрос на команду записи, то переходим в состояние ожидания данных
WAIT_FOR_DATA_ST | WRITE_ST | in_empty = 0 & word_counter_write < (BURST_LIMIT-1) & (fifo_word_count >= word_counter_write or fifo_word_count >= BURST_LIMIT) | Если есть необходимое количество данных для данного burst
WRITE_ST | WRITE_WAIT_BRESP_ST | wvalid = 1 & wready = 1 & wlast = 1 | Когда закончится текущая транзакция burst то переходим в состояние ожидания отклика от Slave
WRITE_WAIT_BRESP_ST | IDLE_ST | BVALID = 1 & BREADY = 1 & has_bresp_flaq = 1 & word_counter_write = 0 | Если записаны все данные переходим в исходное состояние IDLE
WRITE_WAIT_BRESP_ST | WRITE_ST | in_empty = 0 & word_counter_write < BURST_LIMIT & (fifo_word_count => word_counter_write or fifo_word_count => BURST_LIMIT) | Если имеется нужное количество данных на запись, производится переход в состояние записи данных. 


### Необходимые внешние компоненты 

Название компонент | Описание
-------------------|---------
[fifo_in_sync_counted_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_in_sync_counted_xpm/fifo_in_sync_counted.vhd) | Синхронная очередь с поддержкой Slave AXI-Stream интерфейса с возможностью подсчета актуального количества байт внутри очереди для корректной работы burst-транзакций
[fifo_out_pfull_sync_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_out_pfull_sync_xpm/fifo_out_pfull_sync_xpm.vhd) | Синхронная очередь с поддержкой Master AXI-Stream интерфейса с возможностью раннего выставления pfull флага для burst-транзакций


## Лог изменений

**1. 22.07.2020 : v1.0 - первая версия**
- Первая версия компонента

**2. 13.10.2020 : v1.1 - Добавлен файл с описанием**
