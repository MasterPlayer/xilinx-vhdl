# axis_loader_ss

параметризуемый компонент для программирования внешних ПЛИС Xilinx в режиме SlaveSerial. Интерфейс поддерживает протокол AXI-Stream. Производит сериализацию битового потока в соответствии с описанием, которое содержится в гайдах:

* ug470_7Series_Config
* xapp583

Компонент поддерживает разные скорости программирования, и умеет работать в синхронном и асинхронном режиме. Разрядность шины S_AXIS_TDATA имеет различные варианты выбора. Компонент не имеет никакого ручного управления по сравнению с предыдущей реализацией. 

![axis_loader_ss_struct][axis_loader_ss_struct_reg]

[axis_loader_ss_struct_reg]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_loader_ss/documentation/axis_loader_ss_struct.png

## generic-параметры
Параметр | Тип | Диапазон значений | описание
---------|-----|-------------------|---------
N_BYTES  | integer | 1,2,4,8,16,32 | Размер шины данных AXI-Stream
ASYNC_MODE | boolean | "true" или "false" | Асинхронный режим
WAIT_ABORT_LIMIT | integer | 0 - 2^31 | Предел таймаута

## Порты 

### AXI-Stream 

Компонент работает на основе протокола AXI-Stream. Компонент выступает как Slave. Сигналы группы `S_AXIS_*` синхронны по отношению к сигналу `CLK` и `RESET`

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
S_AXIS_TDATA | input | N_BYTES * 8 | сигнал данных
S_AXIS_TKEEP | input | N_BYTES | сигнал валидности байт внутри слова
S_AXIS_TVALID | input | 1 | сигнал валидности
S_AXIS_TREADY | output | 1 | сигнал готовности устройства к приему данных
S_AXIS_TLAST | input | 1 | сигнал конца пакета. Не используется


### сигналы тактирования и сброса 

Сигналы CLK и CLK_SS могут быть подключены к одному источнику. В таком случае установить `ASYNC_MODE = false`

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
CLK | input | 1 | сигнал тактирования шины `S_AXIS`
RESET | input | 1 | сигнал сброса. Синхонный по отношению к CLK
CLK_SS | input | 1 | сигнал тактирования внутренней логики и шины SlaveSerial. на данном тактовом сигнале идет тактирование сигналов, которые взаимодействуют с внешней ПЛИС

### сигналы статуса

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
STS_PROG_GOOD | output | 1 | Программирование завершено, так как внешняя ПЛИС подняла `DONE` в единицу
STS_PROG_FAIL | output | 1 | Программирование завершено с ошибкой, так как внешняя ПЛИС не подняла `DONE` в единицу за интервал времени `WAIT_ABORT_LIMIT`. 

### Сигналы группы SlaveSerial
Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
CCLK | output | 1 | сигнал тактирования внешней ПЛИС для программирования. Берется от сигнала `CLK_SS`(его инверсия)
DIN | output | 1 | сигнал данных для внешней ПЛИС. Получается путем сериализации входного потока
DONE | input | 1 | сигнал завершения программирования поднимается тогда, когда прошивка загружена в ПЛИС без ошибок
INIT_B | input | 1 | сигнал готовности ПЛИС к программированию.
PROG_B | output | 1 | сигнал сброса ПЛИС для возможности дальнейшего программирования

## некоторые принципы работы компонента. 

- Компонент поддерживает AXI-Stream
- Компонент позволяет загружать прошивку в ПЛИС под доменом, который отличается от того на котором работает AXI-Stream шина.
- Компонент игнорирует `S_AXIS_TLAST`, что позволяет грузить прошивку в несколько транзакций на AXI-Stream
- Завершением транзакций является или таймаут(сопровождается флагом `STS_PROG_FAIL`), или сигнал `DONE = 1`(сопровождается флагом `STS_PROG_GOOD`). 
- Компонент поддерживает некратные размеру шины данных транзакции (`S_AXIS_TKEEP` обрабатывается)
- Компонент производит простую сериализацию данных в битовый поток. 
- Пауза между пакетами, если прошивка разбивается на несколько транзакций AXI-Stream не должна превышать `WAIT_ABORT_LIMIT` в тактах.
- Компонент выдает `CCLK` Только тогда, когда передает данные. `CCLK` берется от инверсии `CLK_SS` сигнала 
- Компонент позволяет прошивать данные максимально быстро, насколько это возможно для CLK_SS. Внутренних задержек по факту нет. Частота `CLK_SS` никаким образом не делится. 
- При отсустствии данных на входе - компонент переходит в состояние ожидания данных(если прошивка не загружена полностью), либо в ожидание сигнала `DONE = 1`.
- Входная шина свопается по байтам - старший байт становится младшим.
- В основе работы компонента лежит конечный автомат. 

### иллюстрация свопа байтов

![axis_loader_rsh_fsm][axis_loader_ss_rsh_ref]

[axis_loader_ss_rsh_ref]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_loader_ss/documentation/axis_loader_ss_rsh.png

## Конечный автомат

### Граф-схема автомата 

Структура конечного автомата представлена на рисунке

![axis_loader_ss_fsm][axis_loader_ss_fsm_ref]

[axis_loader_ss_fsm_ref]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_loader_ss/documentation/axis_loader_ss_fsm.png

### Состояния конечного автомата

Текущее состояние | Следующее состояние | Условие перехода
------------------|---------------------|-----------------
WAIT_PROG_ST      | RESET_FPGA_ST       | in_empty = 0 (входная очередь данных не пуста)
RESET_FPGA_ST     | WAIT_FOR_INITB_ST   | INIT_B = 0 (ПЛИС разрешила программирование)
WAIT_FOR_INITB_ST | PROG_FPGA_ST        | INIT_B = 1 (ПЛИС разрешила передачу данных)
PROG_FPGA_ST      | WAIT_DATA_ST        | bit_cnt = cnt_limit_reg and in_empty = 1 (предел счета для данного слова достигнут и входная очередь данных пустая)
WAIT_DATA_ST      | WAIT_PROG_ST        | DONE = 1 (получен сигнал от ПЛИС об успешной прошивке)
WAIT_DATA_ST      | PROG_FPGA_ST        | in_empty = 0(входная очередь содержит данные)
WAIT_DATA_ST      | WAIT_PROG_ST        | wait_abort_cnt = WAIT_ABORT_LIMIT

### Временная диаграмма состояний с отображением работы сигналов SS-группы

Диаграмма нормально работающего состояния представлена на рисунке

![axis_loader_ss_normal][axis_loader_ss_normal_ref]

[axis_loader_ss_normal_ref]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_loader_ss/documentation/axis_loader_ss_normal.png

### Необходимые внешние компоненты 

Название компонент | Описание
-------------------|---------
[fifo_in_sync_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_in_sync_xpm/fifo_in_sync_xpm.vhd) | Примитив синхронной очереди для поддержки Slave AXI-Stream
[fifo_in_async_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_in_async_xpm/fifo_in_async_xpm.vhd) | Примитив асинхронной очереди для поддержки Slave AXI-Stream
[rst_syncer](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/syncronizers/rst_syncer.vhd) | синхронизатор сброса для `ASYNC_MODE = true`


## Лог изменений

**1. 25.09.2019 : v1.0 - первая версия**
- Поддержка 2 байтной шины AXI-Stream, игнорируется `S_AXIS_TLAST` и `S_AXIS_TKEEP`

**2. 03.10.2019 : v1.1 - изменения в работе компонента**
- Добавлена поддержка разрядностей (1/2/4/8) для шины данных
- Добавлена поддержка `S_AXIS_TKEEP`
- Добавлен примитив синхронизации для сброса при `ASYNC_MODE = true`

**3. 03.07.2020 : v1.2 - изменения в работе компонентов**
- Убрано ручное управление переходом компонента в `IDLE_ST` (сигнал `PROG_DONE`)
- Оптимизирован конечный автомат, убрал состояние `WAIT_DONE_ST`
- Добавлено два порта для статуса (`STS_PROG_GOOD`, `STS_PROG_FAIL`)
- Исправлено описание и структура каталога
- Добавлена поддержка 16/32 байт для шины данных