# axis_arb_2_to_1

параметризуемый арбитр 2 в 1 с поддержкой AXI-Stream

Делает коммутацию с двух портов Slave AXI-Stream в один порт Master AXI-Stream. При этом входы имеют равный приоритет. Принцип работы компонента основан на попакетной коммутации. Другими словами, если один из портов S_AXIS начал передавать данные, то внутренняя логика компонента переключится на другой порт только тогда, когда на текущем порту закончится передача текущего пакета. В противном случае конечный автомат компонента зависнет в текущем состоянии. 

## Структура 

![axis_arb_2_to_1][logo1]

[logo1]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_arb_2_to_1/documentation/axis_arb_2_to_1.png

## generic-параметры
Название | Тип | Диапазон значений | Описание
---------|-----|-------------------|---------
N_BYTES | integer | >0 | Размер шины данных в байтах. 

## порты 

### AXI-STREAM

Вся работа компонента основана на поддержке AXI-Stream

#### Slave AXI Stream 0

Название | направление | Разрядность | Назначение
---------|-------------|-------------|-----------
S00_AXIS_TDATA | вход | `N_BYTES*8` | порт данных
S00_AXIS_TKEEP | вход | `N_BYTES` | порт валидности байт внутри слова
S00_AXIS_TVALID | вход | 1 | сигнал валидности
S00_AXIS_TREADY | выход | 1 | сигнал готовности к приему данных со стороны компонента
S00_AXIS_TLAST | вход | 1 | сигнал конца пакета


#### Slave AXI Stream 1 

Название | направление | Разрядность | Назначение
---------|-------------|-------------|-----------
S00_AXIS_TDATA | вход | `N_BYTES*8` | порт данных
S00_AXIS_TKEEP | вход | `N_BYTES` | порт валидности байт внутри слова
S00_AXIS_TVALID | вход | 1 | сигнал валидности
S00_AXIS_TREADY | выход | 1 | сигнал готовности к приему данных со стороны компонента
S00_AXIS_TLAST | вход | 1 | сигнал конца пакета


#### Master AXI Stream 

Название | направление | Разрядность | Назначение
---------|-------------|-------------|-----------
M_AXIS_TDATA | выход | `N_BYTES*8` | порт данных
M_AXIS_TKEEP | выход | `N_BYTES` | порт валидности байт внутри слова
M_AXIS_TVALID | выход | 1 | сигнал валидности
M_AXIS_TREADY | вход | 1 | сигнал готовности к приему данных со стороны устройства, принимающего поток с компонента
M_AXIS_TLAST | выход | 1 | сигнал конца пакета


## Некоторые принципы работы компонента
- Если какой-либо из портов S_AXIS начал передавать данные, и компонент занимается приемом, то переключение на другой порт возможно только тогда, когда текущий порт сообщит TLAST-сигнал
- Приоритет одного порта над другим отсутствует. Конечный равноприоритетно оценивает наличие данных на том или ином порту. 
- В момент, когда пакеты одновременно поступают на входы по обоим портам, передаваться будет пакет с того порта, состояние которого анализировалось в этот момент. 
- Для простоты организации компонента не происходит передачи никаких дополнительных полей. То есть на выходной шине отсутствует возможность оценки с какого конкретного порта приходят данные. 
- Асинхронный режим не поддерживается в текущей реализации. 

## Конечный автомат 

### Граф-схема автомата
Структура конечного автомата представлена на рисунке. 

![axis_arb_2_to_1_fsm][logo_fsm]

[logo_fsm]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_arb_2_to_1/documentation/axis_arb_2_to_1_fsm.png

### Состояния 
текущее состояние | следующее состояние | условие перехода 
-------------------|---------------------|-----------------
CH0_CHECK | CH0_TX | `S00_AXIS_TVALID = 1`
CH0_CHECK | CH1_CHECK | `S00_AXIS_TVALID = 0`
CH1_CHECK | CH1_TX | `S01_AXIS_TVALID = 1`
CH1_CHECK | CH0_CHECK | `S01_AXIS_TVALID = 0`
CH0_TX | CH1_CHECK | `out_awfull = 0` and S00_AXIS_TVALID = 1 and S00_AXIS_TLAST = 1
CH1_TX | CH0_CHECK | `out_awfull = 0` and S01_AXIS_TVALID = 1 and S01_AXIS_TLAST = 1


## Необходимые внешние компоненты:
Название компонента | Описание
--------------------|---------
[fifo_out_sync_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_out_sync_xpm/fifo_out_sync_xpm.vhd) | примитив очереди для данных на отправку для реализации Master AXI-Stream
[axis_dump_gen](https://github.com/MasterPlayer/xilinx-vhdl/tree/master/axis_infrastructure/axis_dump_gen) | необходим для симуляции. 


## Лог изменений

**1. 11.08.2020 v1.0 - первая версия**

