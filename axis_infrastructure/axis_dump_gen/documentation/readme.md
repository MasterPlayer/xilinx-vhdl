# axis_dump_gen

Простой генератор данных для AXI-Stream с возможностью конфигурации ширины шины и возможностью работы в cdc-режиме.

## Структура
![axis_dump_gen scheme](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_dump_gen/documentation/axis_dump_gen.png)

## generic-параметры:
1) `N_BYTES` - позволяет установить размер шины данных, кратной 1 байту. 
2) `ASYNC` - позволяет обеспечить работу генератора и шины в разных тактовых доменах
3) `MODE` - выбор паттерна генератора. Возможна работа в одном из трех режимов:
- `SINGLE` - шина данных представляется как счетчик, который изменяется для каждого слова
- `ZEROS` - на шине данных только нулевые значения
- `BYTE` - генерируется массив восьмибитных счетчиков по всей длине шины

## Порты 

### AXI-STREAM
Выходная шина поддерживает AXI-Stream, в частности следующие сигналы
1) `M_AXIS_TDATA` - сигнал данных. Размер задается в зависимости от N_BYTES
2) `M_AXIS_TKEEP` - сигнал валидности байт на шине данных. Всегда установлен в единицы по всей ширине. размер задается в зависимости от N_BYTES
3) `M_AXIS_TREADY` - сигнал готовности приемника к чтению данных
4) `M_AXIS_TLAST` - сигнал конца пакета
5) `M_AXIS_TVALID` - сигнал валидности данных на шине. 

### Входы
Входы для конфигурации:
1) `WORD_LIMIT` - количество слов в пакете (1 слово = N_BYTES байт). Допустимый диапазон значений [00000001h..ffffffffh]. Комбинация 0x00000000 запрещена и работа генератора не будет произведена до тех пор, пока не будет задан корректный размер пакета
2) `PAUSE` - размер паузы между пакетами в тактах. Допустимый диапазон от [00000000h до FFFFFFFFh]. При установке значения 0 генератор работает без пауз, выдавая один пакет за другим. 
3) `ENABLE` - включить/выключить генератор. 

Некоторые принципы работы:
- Если запустить генератор и остановить, то остановка произойдет в тот момент, когда пакет будет полностью передан. 
- Если в момент передачи пакета попытаться остановить генератор, то генератор закончит передавать текущий пакет
- Если в момент передачи пакета попытаться изменить его размер, то размер пакета изменится только тогда, когда закончится передаваться текущий пакет. 
- Если в момент паузы попытаться изменить размер паузы, то пауза будет изменена только при следующем цикле передачи пакета. 
- Если в момент паузы остановить генератор, то генератор выдаст один пакет и выключится. 

`M_AXIS_TKEEP` всегда равен единице, так как побайтовый режим не поддерживается.

Текущая скорость генератора (при условии что TREADY = '1' всегда) получается по следующей формуле:

**SPEED = (WORD_LIMIT/(WORD_LIMIT + PAUSE)) x (N_BYTESx8) x CLK_PERIOD**

где `SPEED` - скорость данных в бит/с
`WORD_LIMIT` - Количество слов в пакете
`PAUSE` - размер паузы
`N_BYTES` - ширина шины данных в байтах
`CLK_PERIOD` - период тактового сигнала от которого тактируется внутренняя логика

## Необходимые внешние компоненты:
1) [fifo_out_sync_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_out_sync_xpm/fifo_out_sync_xpm.vhd) при использовании `ASYNC_MODE = false`
2) [fifo_out_async_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_out_async_xpm/fifo_out_async_xpm.vhd) при использовании `ASYNC_MODE = true`

## Лог изменений:

**1. 11.08.2019 v1.0 - первая версия компонента**
- Позволяет отправлять массив счетчиков 8 бит, распределенных по шине N_BYTES
- Поддержка AXI-Stream
- Поддержка разных частотных доменов между логикой работы и выходом M_AXIS_*

**2. 17.11.2019 v1.1 - апдейт изменений, не затрагивает логику работы компонента**

**3. 14.02.2020 v1.2 - изменения в работе компонента**
- Добавлен режим генерации счетчика: счетчик равен ширине слова N_BYTES

**4. 26.03.2020 v1.2 - изменения в работе компонента**
- Добавлена возможность представить шину данных как нули. 
- Компонент работает, но с некоторыми ограничениями:
1) нельзя выставить паузу = 0
2) не рекомендуется переход с генерации пакетов большого размера на пакеты малого размера без перезагрузки генератора
3) параметры WORD_LIMIT и PAUSE необходимо задавать меньше на единицу от реального размера размера пакета/паузы соответственно. К примеру, для генерации пакета = 8192 байт в 64-битной шине необходимо задать размер пакета генератору 0x000003FF (1023). 

**5. 18.06.2020 v1.3 - изменения в работе компонента**
- Добавлена возможность работать на нулевых паузах
- Добавлена возможность понижения размера пакета в любой момент времени
- Изменен generic: все три режима генерации счетчика теперь подчиняются одному generic-параметру MODE, а не трем. 
- Добавлен testbench-файл для возможности запустить и протестировать компонент. 
- Обновление описания.

**6. 21.06.2020 v1.4 - изменения в работе компонента**
- Скорректированы счетчики `WORD_LIMIT`, `PAUSE`

**7. 02.07.2020 v1.5 - изменения в работе компонента **
- Скорректирован выход из `PAUSE_ST` в IDLE_ST если `ENABLE = 0` при `PAUSE > 0` 
- Скорректирован выход из `TX_ST` в IDLE_ST если `ENABLE = 0` при `PAUSE > 0`
До этого компонент не умел так переходить. 

**8. 02.07.2020 v1.6 - изменения в работе компонента **
- Скорректированный выход из `PAUSE_ST` в IDLE_ST если `ENABLE = 0` при `PAUSE > 0` : Переход должен быть запрещен, так как в таком случае мы не можем генерировать одиночный пакет. 

**9. 29.07.2020 v1.7 - изменения в работе компонента ** 
- Скорректировано переприсваивание word_limit_reg в случае, если в процессе работы компонента мы меняем размер. 

**10. 20.09.2021 v1.8 - изменения в работе компонента ** 
- Исправлена ошибка с разрядностью регистра для счетчика размера пакетов(word_counter) - она была 16 бит, в то время как разрядность PACKET_SIZE - 32 бит. Данная проблема вызывала ситуацию, при которой если задается размер пакета > 65536(включительно), то генератор не имеет возможности остановки и работает без пауз. Только сброс мог вызвать изменение состояния генератора. Решение проблемы: Разрядность 16 бит была исправлена на 32 для счетчика размера пакета.
