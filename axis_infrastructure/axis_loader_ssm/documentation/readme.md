# axis_loader_ssm

параметризуемый компонент для программирования внешних ПЛИС Xilinx в режиме SlaveSelectMAP. Интерфейс поддерживает протокол AXI-Stream. 

* ug470_7Series_Config
* xapp583

Компонент поддерживает разные скорости программирования, и умеет работать в синхронном и асинхронном режиме. Разрядность шины данных S_AXIS_TDATA возможна только в 8 бит. 

![axis_loader_ssm_struct][axis_loader_ssm_struct_ref]

[axis_loader_ssm_struct_ref]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_loader_ssm/documentation/axis_loader_ssm_struct_ref.png

## generic-параметры
Параметр | Тип | Диапазон значений | описание
---------|-----|-------------------|---------
N_BYTES  | integer | 1 | Размер шины данных AXI-Stream. в текущей версии - только 8 бит
ASYNC_MODE | boolean | "true" или "false" | Асинхронный режим
WAIT_DONE_LIMIT | integer | 0 - 2^31 | Предел таймаута при ожидании сигнала DONE после полной загрузки прошивки в тактах SM_CLK. При 0 - переход по таймауту не произойдет
CONTROL | string | "SIZE" или "LAST" | По какому событию выходить в состояние ожидания DONE


## Порты 

### AXI-Stream 

Компонент работает на основе протокола AXI-Stream. Компонент выступает как Slave. Сигналы группы `S_AXIS_*` синхронны по отношению к сигналу `CLK` и `RESET`

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
S_AXIS_TDATA | input | N_BYTES * 8 | сигнал данных
S_AXIS_TKEEP | input | N_BYTES | сигнал валидности байт внутри слова, в текущем варианте игнорируется
S_AXIS_TDEST | input | 8 | сигнал DESTINATION для реализации возможности прошивки одним модулем нескольких ПЛИС. В текущем варианте не используется. 
S_AXIS_TVALID | input | 1 | сигнал валидности
S_AXIS_TREADY | output | 1 | сигнал готовности устройства к приему данных
S_AXIS_TLAST | input | 1 | сигнал конца пакета. Используется только при `CONTROL = LAST`, иначе игнорируется

### сигналы тактирования и сброса 

Сигналы `CLK` и SM_CLK могут быть подключены к одному источнику. В таком случае установить `ASYNC_MODE = false`

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
CLK | input | 1 | сигнал тактирования шины `S_AXIS`
RESET | input | 1 | сигнал сброса. Синхонный по отношению к `CLK`
SM_CLK | input | 1 | сигнал тактирования внутренней логики и шины SlaveSerial. на данном тактовом сигнале идет тактирование сигналов, которые взаимодействуют с внешней ПЛИС
SM_RESET | input | 1 | сигнал сброса. Синхонный по отношению к `SM_CLK`. Сигнал сбрасывает внутреннюю логику


### сигналы управления 
Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
BITSTREAM_SIZE | input | 32 | сигнал лимита для текущей прошивки. Действует при выборе режима `CONTROL = SIZE`, в противном случае игнорируется. Синхронный сигнал по отношению к `SM_CLK`.


### сигналы статуса

Внимание: Сигналы синхронны по отношению к `SM_CLK`

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
STS_DONE | output | 1 | сигнал состояния программирования. Валиден только при `STS_EVENT`, сохраняет свое последнее состояние при `STS_EVENT = 0`
STS_EVENT | output | 1 | сигнал валидности: срабатывает при наступлении двух событий: при начале программирования и при поднятии сигнала `DONE`
BITSTREAM_COUNTER | output | 32 | сигнал переданных байт прошивки на программируемую FPGA. 

### Сигналы группы SlaveSerial

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
CCLK | output | 1 | сигнал тактирования внешней ПЛИС для программирования. Берется от сигнала `CLK_SS`(его инверсия)
DATA | output | 8 | сигнал данных для внешней ПЛИС. Получается путем свопа бит входного сигнала `S_AXIS_TDATA`
DONE | input | 1 | сигнал завершения программирования поднимается тогда, когда прошивка загружена в ПЛИС без ошибок
INIT_B | input | 1 | сигнал готовности ПЛИС к программированию.
PROG_B | output | 1 | сигнал сброса ПЛИС для возможности дальнейшего программирования
CS | output | 1 | сигнал выбора чипа ChipSelect

## некоторые принципы работы компонента. 

- Компонент поддерживает AXI-Stream. Поддерживается только одна разрядность данных = 8 бит. 
- Компонент позволяет загружать прошивку в ПЛИС под доменом, который отличается от того на котором работает AXI-Stream шина с пользовательской логикой.
- при `CONTROL = SIZE` компонент игнорирует `S_AXIS_TLAST`, что позволяет грузить прошивку в несколько транзакций на AXI-Stream. Выход в состояние ожидания `DONE = 1` осуществляется по счетчику отправленных байт.
- при `CONTROL = LAST` компонент игнорирует `BITSTREAM_SIZE`. Выход в состояние ожидания `DONE = 1` осуществляется по сигналу `S_AXIS_TLAST`.
- Завершением транзакций является или таймаут или сигнал `DONE = 1`. 
- Пауза между пакетами допускается любая
- Компонент выдает `CCLK` Только тогда, когда передает данные. `CCLK` берется от инверсии `SM_CLK` сигнала 
- Компонент позволяет прошивать данные максимально быстро, насколько это возможно для `SM_CLK`. Внутренних задержек по факту нет. Частота `SM_CLK` никаким образом не делится на выход `CCLK`
- При отсустствии данных на входе компонент выставляет CS в единицу и ожидает данных бесконечно долго. Выход по таймауту отсутствует. 
- Входная шина свопается по битам - старший бит становится младшим.
- В основе работы компонента лежит конечный автомат. 
- При завершении программирования до ожидания сигнала `DONE = 1` сигнал CS будет равен нулю. 

### иллюстрация свопа битов

![axis_loader_ssm_swap][axis_loader_ssm_swap_ref]

[axis_loader_ssm_swap_ref]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_loader_ssm/documentation/axis_loader_ssm_swap_ref.png


## Конечный автомат

### Граф-схема автомата 

Внимание: Принцип работы конечного автомата отличается в зависимости от выбранного режима `CONTROL`

### Состояния конечного автомата

Текущее состояние | Следующее состояние | Условие перехода
------------------|---------------------|-----------------
IDLE      | RESET_FPGA_ST       | in_empty = 0 (входная очередь данных не пуста)
RESET_FPGA_ST     | WAIT_FOR_INITB_ST   | INIT_B = 0 (ПЛИС разрешила программирование)
WAIT_FOR_INITB_ST | LD_BITSTREAM        | INIT_B = 1 (ПЛИС разрешила передачу данных)
LD_BITSTREAM      | WAIT_DONE_ST        | in_empty = 0, CONTROL = "SIZE", bitstream_size_cnt = bitstream_size_reg (очередь не пуста при режиме CONTROL = SIZE и количестве байт равно заданному извне)
LD_BITSTREAM      | WAIT_DONE_ST        | in_empty = 0, CONTROL = "LAST", in_dout_last = 1 (при непустой очереди при режиме CONTROL = LAST и сигналу конца пакета)
WAIT_DONE_ST      | IDLE_ST        | DONE = 1 (получен сигнал от ПЛИС об успешной прошивке), или при таймауту при WAIT_DONE_LIMIT > 0


### Временная диаграмма состояний с отображением работы сигналов SS-группы

Диаграмма нормально работающего состояния представлена на рисунке

![axis_loader_ssm_normal][axis_loader_ssm_normal_ref]

[axis_loader_ssm_normal_ref]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_loader_ssm/documentation/axis_loader_ssm_normal.png


### Необходимые внешние компоненты 

Название компонент | Описание
-------------------|---------
[fifo_in_sync_user_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_in_sync_user_xpm/fifo_in_sync_user_xpm.vhd) | Примитив синхронной очереди для поддержки Slave AXI-Stream
[fifo_in_async_user_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_in_async_user_xpm/fifo_in_async_user_xpm.vhd) | Примитив асинхронной очереди для поддержки Slave AXI-Stream


## Лог изменений

**1. 04.11.2021 : v1.0 - первая версия**
- Базовая версия компонента. Только 8 бит, два режима работы


