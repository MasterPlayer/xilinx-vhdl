# axis_data_delayer

Параметризуемый компонент для компенсации целостности пакета от начала до конца. 
Нужен в тех ситуациях, когда после перехода с более медленного частотного домена в более быстрый компенсировать разрывы по валидным данным внутри пакета, таким образом избежав необходимости "копить пакет" и вмешиваться в поведение потока. Другими словами: На вход поступает пакет, в котором между словами есть паузы(когда данные невалидны). Данный компонент компенсирует эти паузы, не осуществляя накопления пакета(таким образом исключая в работе компонента зависимость от размера пакета, поступающего на вход). Время за которое первое слово появляется на входе, и появляется на выходе в таком случае для любого размера пакета будет фиксированным. 

Структура компонента:

![axis_data_delayer_structure][axis_data_delayer_structure_reg]

[axis_data_delayer_structure_reg]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_data_delayer/documentation/axis_data_delayer_struct.png

Диаграмма, демонстрирующая пример работы компонента:

![axis_data_delayer_beh][axis_data_delayer_beh_reg]

[axis_data_delayer_beh_reg]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_data_delayer/documentation/axis_data_delayer_behave.png


## generic-параметры
Параметр | Тип | Диапазон значений | описание
---------|-----|-------------------|---------
DW | integer | >0 | Разрядность шины данных
DELAY | integer | >0 | Размер задержки данных от входа до выхода компонента. 
MEMTYPE | string | "auto"/"distributed"/"block" | Тип используемой памяти для очередей
MAX_PKT_SIZE | integer | >16 | максимальный размер пакета 

## Порты 

### сигналы тактирования и сброса 

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
CLK | input | 1 | сигнал тактирования
RESET | input | 1 | сигнал сброса. Синхонный по отношению к CLK

Примечание: Компонент не поддерживает асинхронного режима. Вся логика работает в одном частотном домене

### отладочные сигналы

Сигналы предназначаются для отладки, могут не использоваться. 

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
DBG_OVERLOAD_DATA | output | 1 | сигнал переполненности очереди данных
DBG_OVERLOAD_TIMER | output | 1 | сигнал переполненности очереди отсчетов счетчика

### AXI-Stream 

Компонент работает на основе протокола AXI-Stream и выступает в роли Slave для приема данных, и в роли Master для передачи данных

Компонент не поддерживает TREADY. 

Все сигналы тактируются от CLK. Сигналом сброса служит RESET.

#### AXI-Stream Slave

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
S_AXIS_TDATA | input | DW | сигнал данных 
S_AXIS_TKEEP | input | DW/8 | сигнал валидности байт в текущем слове
S_AXIS_TVALID | input | 1 | сигнал валидности
S_AXIS_TLAST | input | 1 | сигнал конца пакета.

#### AXI-Stream Master

Название | Направление | Разрядность | Назначение
---------|-------------|-------------|-----------
M_AXIS_TDATA | output | DW | сигнал данных 
M_AXIS_TKEEP | output | DW/8 | сигнал валидности байт в текущем слове
M_AXIS_TVALID | output | 1 | сигнал валидности
M_AXIS_TLAST | output | 1 | сигнал конца пакета.


## некоторые принципы работы компонента. 

- В работе компонента участвует конечный автомат
- В структуре компонента заложено две очереди, одна из которых предназначена для хранения данных, другая - для хранения отсчетов счетчика. 
- Компонент работает на основе двух счетчиков. Назначение первого счетчика(timer_cnt_0) - записать метку момента поступления на вход первого слова. Второй счетчик при этом предназначен для того чтобы выдержать паузу (`DELAY`) для вычитывания данных. Когда значение второго счетчика сравняется с записанным в очередь отсчетом первого счетчика, начинается передача данных из очереди наружу через порт `M_AXIS_`
- Порядок функционирования `timer_cnt_0` : Когда приходит первое слово, в очередь отсчетов записывается временная метка первого счетчика.
- Порядок функционирования `timer_cnt_1` : после сброса счетчик ждет пока `timer_cnt_0` досчитает до паузы `DELAY`, после этого на каждом такте начинает считать.
- Параметр `DELAY` вычисляется на на основе максимального размера пакета(`MAX_PKT_SIZE`) и значения количества тактов, сколько этот пакет длится во времени(в тактах). Пример:
Если максимальный размер пакета равен 1024 слова, то размер DELAY не может быть меньше чем это значение. При этом, если где-то до компонента произошел переход из более медленного частотного домена(к примеру, 50 МГц) в более быстрый домен(156.25 МГц), то параметр `DELAY` будет вычисляться в соответствии со следующим выражением:

![delay_eqn_field][delay_eqn_field_reg]

[delay_eqn_field_reg]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_data_delayer/documentation/delay_eqn.png

для текущего случая получится что необходимо выставить delay = 3200. 

- Размеры очередей задаются по максимальному размеру пакета. 
- Между пакетами должна быть обязательно пауза в один такт. В противном случае, компонент может сломаться. 
- Компонент не поддерживает TREADY. 
- Компонент не должен работать в системах, где пакет не содержит в своем составе разрывов по данным относительно CLK-сигнала. В таком случае, использование этого компонента не требуется
- Компонент не изменяет данные
- Компонент не копит пакет. Компонент их задерживает. При накоплении данных появляется зависимость, которая заключается в том, что чем меньше пакет - тем быстрее он будет выдаваться на выход. Если пакет больше - то он сперва накопится полностью, потом выдастся на выход. Таким образом, величина DELAY будет изменяться в зависимости от размера текущего пакета, а в ряде случаев это недопустимо. 
- Компонент содержит отладочные сигналы группы `DBG`. По ним на этапе моделирования можно оценить переполненность очередей. 
- Разрядность шин данных является конфигурируемой
- Тип памяти можно задавать любой. 

## Конечный автомат

Работа строится на конечном автомате, назначение которого - накопление данных в одном состоянии, и выдача в другом состоянии. 

### Граф-схема автомата 

![fsm_diag][fsm_diagram]

[fsm_diagram]:https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_data_delayer/documentation/fsm_diag.png

### Состояния конечного автомата 

Текущее состояние | Следующее состояние | Условие перехода | Пояснение
------------------|---------------------|------------------|----------
WAIT_ST | READ | timer_empty = 0 and timer_cnt_1 = timer_dout | Если в очереди отсчетов есть данные, то переход к передаче пакета со входа
READ | WAIT_ST | data_dout_last = 1 and timer_cnt_1 /= timer_dout | Если передача текущего пакета закончена, то переход в WAIT_ST


### Необходимые внешние компоненты 

Название компонент | Описание
-------------------|---------
[fifo_in_sync_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_in_sync_xpm/fifo_in_sync_xpm.vhd) | Синхронная очередь с поддержкой Slave AXI-Stream интерфейса, необходима для хранения данных, поступающих от входа `S_AXIS_` и передавачи их на выход `M_AXIS`
[fifo_cmd_sync_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_cmd_sync_xpm/fifo_cmd_sync_xpm.vhd) | синхронная очередь для хранения временных отсчетов момента начала поступления данных на вход


## Лог изменений

**2. 13.10.2020 : v1.1 - Добавлен файл с описанием**
