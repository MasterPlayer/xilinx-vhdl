# axis_collector

Компонент для сбора, хранения (накопления) и передачи данных с нескольких каналов. Поток представляет собой данные, которые поступают с различных каналов в случайные моменты времени. Компонент коллекционирует эти данные в зависимости от идентификатора канала в сегменты, производит упорядочивание данных, и передает только полностью готовые пакеты.

Готовый сегмент вычисляется исходя из формулы:

**SEGMENT_BYTE_SIZE/SEGMENT_MAX_PKTS**

Компонент является параметризуемым по различным параметрам, таким как разрядность входа/выхода, работа в синхронном/асинхронном режиме, количество сегментов и размеры этих сегментов, количество пакетов сколько может храниться в сегменте. 

Компонент поддерживает ассиметричную разрядность, когда вход имеет одну разрядность, а выход - другую. 

## Структура

![axis collector][logo]

[logo]: https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_collector/documentation/axis_collector.png "Logo Title Text 2"

## generic-параметры

Компонент содержит несколько параметров чтобы можно было обеспечить гибкую конфигурацию

### список generic

№ | Параметр | тип | ограничения | описание
--|----------|-----|-------------|---------
1 | N_CHANNELS | integer | > 1 |количество каналов на которые сегментируется память
2 | N_CHANNELS_W | integer | >log2(N_CHANNELS) | разрядность шины TID
3 | SEGMENT_BYTE_SIZE | integer | >0( см.**1**) | размер каждого сегмента, который хранит данные
4 | N_BYTES_IN | integer | >0 | Входная разрядность шины данных в байтах
5 | N_BYTES_OUT | integer | >0 | Выходная разрядность шины данных в байтах
6 | ASYNC_MODE | boolean | true или false |Асинхронный режим. Позволяет производить работу в разных тактовых доменах
7 | SEGMENT_MAX_PKTS | integer | >0 |Количество пакетов внутри одного сегмента
8 | ADDR_USE | string | "full" или "high" |параметр формирования адресации
9 | TUSER_WIDTH | integer | >=1(см.**2**) | разрядность шины TUSER

**1** в зависимости от параметра ADDR_USE используются следующие условия:
- При `ADDR_USE = high` параметр должен удовлетворять условиям:

SEGMENT_BYTE_SIZE >= N_BYTES_IN 
SEGMENT_BYTE_SIZE >= N_BYTES_OUT

В противном случае генерация невозможна

- При `ADDR_USE = full` параметр должен удовлетворять условиям:

SEGMENT_BYTE_SIZE >= N_BYTES_IN + ширина TUSER
SEGMENT_BYTE_SIZE >= N_BYTES_IN + ширина TUSER

Таким образом, при 

`N_BYTES_IN = 1` 

`N_BYTES_OUT = 1`

`TUSER = 1`

`SEGMENT_BYTE_SIZE` не может быть меньше 2

**2** Если используется `ADDR_USE = high`, то размер TUSER не влияет на работу, так как он не учитывается. 


## Порты

### AXI-Stream 

**Внимание**
> Компонент имеет возможность работать по разным тактовым доменам между S_AXIS и M_AXIS шинами, в том числа и для внутренней логики. В случае, если `ASYNC_MODE = false`, порты `S_AXIS_CLK` и `M_AXIS_CLK` подключаются к одному и тому же тактовому сигналу, а сигналы `S_AXIS_RESET` и `M_AXIS_RESET` - к одному и тому же сигналу сброса. 

#### Slave AXI-Stream 
Название | направление |Разрядность | Назначение
---------|-------------|------------|-----------
S_AXIS_CLK | вход | 1 | сигнал тактирования S_AXIS-инфраструктуры
S_AXIS_RESET | вход | 1 | сигнал сброса логики S_AXIS-инфраструктуры
S_AXIS_TDATA | вход | N_BYTES_IN*8 | сигнал входных данных
S_AXIS_TID | вход | N_CHANNELS | сигнал номера канала для идентификации сегмента куда складывать пакет
S_AXIS_TUSER | вход | TUSER_WIDTH | сигнал для упорядочивания данных внутри одного сегмента. Участвует в адресации в качестве младшего разряда. При `ADDR_USE = high` не используется. 
S_AXIS_TVALID| вход | 1 | сигнал валидности данных на шине

#### Master AXI-Stream
Название | направление | Разрядность | Назначение
---------|-------------|-------------|-----------
S_AXIS_CLK | вход | 1 | сигнал тактирования M_AXIS-инфраструктуры
S_AXIS_RESET | вход | 1 | сигнал сброса логики M_AXIS-инфраструктуры
M_AXIS_TDATA | выход | N_BYTES_OUT*8 | сигнал выходных данных
M_AXIS_TID | выход | N_CHANNELS | сигнал номер канала для идентификации. Необходим для того, чтобы имелась возможность коммутации
M_AXIS_TVALID | выход | 1 | сигнал валидности данных 
M_AXIS_TREADY | вход | 1 | сигнал готовности приемника

## Некоторые принципы работы компонента
- Компонент коллекционирует поступающий поток, разбивает его на сегменты и производит запись во внутреннюю память в зависимости от номера сегмента. Номер сегмента определяется сигналом `S_AXIS_TID`.
- Компонент умеет работать только по словам, поддержка байт внутри одного слова не обеспечивается (`TKEEP`-сигнал отсутствует)
- Компонент рассчитан на работу, при которой несколько низкоскоростных потоков данных поступают на его вход, а компонент уже занимается тем, что производит разделение и упорядочивание данных внутри одного пакета. `TREADY` не поддерживается со стороны Slave AXI-Stream.
- Под одним низкоскоростным потоком понимается такой поток, у которого какой-то определенный TID. 
- При использовании `ADDR_USE = "full"` в формировании адреса участвует `TUSER`-сигнал, разрядность которого конфигурируема. Необходимость в использовании `TUSER` возникла потому что данные, которые поступали на вход, мешались внутри одного пакета. 
- Если Master AXI-Stream будет работать медленнее чем входной поток данных, то может происходить перезапись данных с потерей части уже записанных данных внутри памяти. Это происходит так как Slave AXI-Stream не поддерживает сигнал `TREADY`.
- На практике `TID` обозначал номер канала узкополосного сигнала, а `TUSER` - номер АЦП. При этом после фильтрации номера АЦП меняли свой порядок, а надо было сохранить поток в том формате и в том порядке, который был до фильтрации. 
- При использовании `ADDR_USE = "high"` адрес к памяти формируется только на основе внутреннего счетчика адреса и `TID` для адресации сегмента. `TUSER` при этом не используется. 
- Пакет выдается на Master AXI-Stream без `TLAST` сигнала, но с номером канала.  
- Размер пакета должен быть кратен `N_BYTES_IN` и `N_BYTES_OUT`. Работа, при которой входная шина данных имеет разрядность 24 бит, а выходная - 16 бит не гарантируется и не проверялась. 

Структура формирования адреса для записи (`ADDRA`) и чтения (`ADDRB`) для различных режимов представлена на рисунке:

![addra structure][logo1]
![addrb structure][logo2]

[logo1]: https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_collector/documentation/addra_reg.png "Logo Title Text 2"

[logo2]: https://github.com/MasterPlayer/xilinx-vhdl/blob/master/axis_infrastructure/axis_collector/documentation/addrb_reg.png "Logo Title Text 2"

## Необходимые внешние компоненты:

Название компонента | Описание
--------------------|---------
[sdpram_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/ram_parametrized/sdpram_xpm/sdpram_xpm.vhd) | примитив памяти для хранения данных
[fifo_cmd_async_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_cmd_async_xpm/fifo_cmd_async_xpm.vhd) | примитив очереди для хранения запросов готовых пакетов на отправку при `ASYNC_MODE = "true"`
[fifo_cmd_sync_xpm](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_cmd_sync_xpm/fifo_cmd_sync_xpm.vhd) | примитив очереди для хранения запросов готовых пакетов на отправку при `ASYNC_MODE = "false"`
[fifo_out_sync_xpm_id](https://github.com/MasterPlayer/xilinx-vhdl/blob/master/fifo_parametrized/fifo_out_sync_xpm_id/fifo_out_sync_xpm_id.vhd) | примитив очереди для данных на отправку для реализации Master AXI-Stream
[axis_dump_gen](https://github.com/MasterPlayer/xilinx-vhdl/tree/master/axis_infrastructure/axis_dump_gen) | необходим для симуляции. 

## Лог изменений

**1. 18.08.2019 v1.0 - первая версия**

**2. 27.08.2019 v1.1 - Изменения в работе компонента**
- Добавлена поддержка TUSER
- Добавлена возможность выбора формирования адреса (`ADDR_USE`)
1) "full" - адрес формируется с использованием TUSER-сигнала
2) "high" - адрес формируется без использования TUSER-сигнала 

**3. 28.06.2020 v1.2 - Изменения в работе компонента**
- Добавлена поддержка проверки условий при генерации памяти/очередей. 
- Изменена структура каталога
- Обновлено описание компонента